# Tasks for 2025-11-10

## Data Quality Issues - Heat Scores Coverage

### Problem
Currently only **6 out of 55 wave events** have heat-level scoring data in the database. The EVENT_STATS_VIEW only shows 4 events with complete data (where heat scores + heat progression both exist and match).

**Current Coverage:**
- Total wave events in database: 55
- Events with HEAT_SCORES data: 6
- Events with HEAT_PROGRESSION data: 6
- Events in EVENT_STATS_VIEW: 4 (those with matching data)
- **Missing: 51 events need heat scoring data**

### Root Cause Analysis Needed

1. **Check PWA_IWT_HEAT_SCORES table:**
   - Only 1,901 records total
   - Why are only 6 events scraped?
   - Are the other events missing from source, or scraper issue?

2. **Check PWA_IWT_HEAT_PROGRESSION table:**
   - 219 heat structures total
   - Only 6 events have progression data
   - Need to verify if other events have this data available

3. **Data matching issues:**
   - Some events have scores but not progression (or vice versa)
   - Need to investigate why 2 events have data but don't show in view

### Tasks

#### 1. Investigate Missing Heat Data
- [ ] Run PWA heat scraper for all 55 wave events
- [ ] Check if PWA website has heat data for older events (2016-2024)
- [ ] Document which events don't have heat data available at source

#### 2. Fix Heat Scores Data Collection
- [ ] Review `src/scrapers/pwa_heat_scraper.py`
- [ ] Check if scraper is limited to recent events only
- [ ] Update scraper to collect all available heat data
- [ ] Re-run scraper for missing events

#### 3. Fix Heat Progression Data Collection
- [ ] Review heat progression scraping logic
- [ ] Ensure all events with heats also have progression data
- [ ] Verify division matching between HEAT_SCORES and HEAT_PROGRESSION

#### 4. Data Quality Verification
- [ ] After re-scraping, verify EVENT_STATS_VIEW coverage
- [ ] Goal: All events with heat data should appear in view
- [ ] Ensure sex column is populated for all records

### Expected Outcome
- All events with available heat data scraped and loaded
- EVENT_STATS_VIEW shows all events with complete heat scoring
- Event Stats API endpoint works for maximum number of events

---

## Event Stats API - Status: ✅ WORKING

The Event Stats API endpoint has been **successfully implemented** and is working correctly for events with complete data.

### Completed
- ✅ Created EVENT_STATS_VIEW database view
- ✅ Implemented `GET /api/v1/events/{event_id}/stats` endpoint
- ✅ Added Pydantic models for response structure
- ✅ Fixed sex column population via JOIN to HEAT_PROGRESSION
- ✅ Tested with event ID 14 (Tenerife Grand Slam)
- ✅ Feature branch: `feature/event-stats-api`

### API Endpoint Details
**URL:** `GET /api/v1/events/{event_id}/stats?sex=Women|Men`

**Returns:**
- Summary stats (best heat, jump, wave scores)
- Move type statistics with averages
- Complete lists of all heat/jump/wave scores
- Metadata (total heats, athletes, timestamp)

**Performance:**
- Uses database view (EVENT_STATS_VIEW) for efficiency
- Pre-aggregated statistics
- Reduced from 9 queries to 7 queries

### Next Steps
1. Fix data coverage (see tasks above)
2. Test with more events once data is complete
3. Merge feature branch to main when data is ready

---

---

## PWA Heat Athlete ID Mapping - Status: 87.5% Complete

### Current Status
**Branch:** `fix/pwa-heat-athlete-id-mapping`

**Coverage:**
- Triple-match strategy (event_id + sail_number + surname): 224/256 athlete IDs mapped (87.5%)
- Script created: `add_pwa_heat_athlete_ids.py`
- Successfully identifies athletes across PWA heat and result data

### Identified Issues

#### 1. Sail Number Discrepancies (23 athletes - 71.9% recoverable)
Athletes changing sail numbers between heats and finals:
- Example: Julian Salmonn uses G-901 in heats, G-21 in finals
- Example: Moritz Mauch uses G-103 in heats, GC-103 in finals
- **Solution ready:** Fallback matching on event_id + surname only (no sail number)
- **Impact:** Would increase coverage from 87.5% to 96.5% (+23 athletes)
- **Risk:** 1 ambiguous match (Sanllehy_CAT-1111 could be Aleix or Eric Sanllehy - both men)

#### 2. Data Quality Issues - PWA Source Data
- **Sex field empty:** PWA_IWT_HEAT_RESULTS.sex is blank for all 5,595 records
- **Division codes mostly empty:** Only 304/5,595 heats have division_code populated
- **Cannot use gender matching:** Both fields needed for disambiguation are missing

#### 3. Unmappable Athletes (9 athletes)
- **Multi-word surnames (3):** Kolpikova Bala, Kiefer Quintana, van Dam Sanchidrian
  - Surname extraction logic fails on compound last names
  - Could be fixed with better parsing
- **DNF/DNS (5):** Ercen, Raskina, Eicker, Bail, Hölzl
  - Surnames never appear in final results
  - Legitimately unmappable
- **Unknown (1):** Ben Roca Ward

### Tasks - Future Improvement

- [ ] Implement surname-only fallback matching for 23 athletes
- [ ] Handle Sanllehy ambiguous case (manually select or skip)
- [ ] Improve multi-word surname extraction (SUBSTRING_INDEX limitations)
- [ ] Consider re-scraping PWA heat data to get sex/division_code fields
- [ ] Test API endpoints with improved coverage
- [ ] Merge to main when satisfied with coverage

### Decision
**Deferred** - Current 87.5% coverage is acceptable for now. Focus on API development.
Will revisit to implement fallback matching when needed for production completeness.

---

## Notes
- Current working events: IDs 14, 16, 27, 39 (and 2 others)
- Feature branch created and code committed
- API is production-ready, just needs more source data
